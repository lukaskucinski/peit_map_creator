<!-- Side Panel UI Template for PEIT Map Creator -->
<!-- This template provides the collapsible side panel with About section and legend -->

<style>
    /* Side panel container */
    #side-panel {
        position: fixed;
        top: 0;
        left: 0;
        width: 350px;
        height: 100vh;
        background: white;
        box-shadow: 2px 0 8px rgba(0,0,0,0.2);
        z-index: 1001;
        transition: transform 0.3s ease-in-out;
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
    }

    #side-panel.collapsed {
        transform: translateX(-350px);
    }

    /* Adjust Leaflet controls position to account for panel */
    body:not(.panel-collapsed) .leaflet-left {
        left: 350px !important;
        transition: left 0.3s ease-in-out;
    }

    body:not(.panel-collapsed) .leaflet-control-download {
        right: 10px !important;
        transition: right 0.3s ease-in-out;
    }

    body.panel-collapsed .leaflet-left {
        left: 0 !important;
        transition: left 0.3s ease-in-out;
    }

    body.panel-collapsed .leaflet-control-download {
        right: 10px !important;
        transition: right 0.3s ease-in-out;
    }

    /* Toggle button */
    #panel-toggle {
        position: absolute;
        top: 50%;
        right: -20px;
        transform: translateY(-50%);
        width: 20px;
        height: 60px;
        background: white;
        border: 2px solid rgba(0,0,0,0.2);
        border-left: none;
        border-radius: 0 8px 8px 0;
        box-shadow: 2px 0 6px rgba(0,0,0,0.15);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        color: #333;
        transition: background 0.2s;
    }

    #panel-toggle:hover {
        background: #e0e0e0;
    }

    /* Panel content area */
    .panel-content {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    /* About section */
    .about-section {
        margin-bottom: 20px;
    }

    .about-section details {
        background: #f8f9fa;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .about-section summary {
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        color: #333;
        user-select: none;
    }

    .about-section summary:hover {
        color: #007bff;
    }

    .about-content {
        margin-top: 10px;
        font-size: 12px;
        line-height: 1.6;
        color: #444;
    }

    .about-content p {
        margin: 8px 0;
    }

    /* Legend section */
    .legend-section {
        border-top: 2px solid #ddd;
        padding-top: 15px;
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .legend-section h4 {
        margin: 0 0 12px 0;
        font-size: 14px;
        font-weight: bold;
        color: #333;
    }

    .legend-items {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
    }

    .legend-item {
        padding: 8px 0;
        font-size: 13px;
        color: #333;
        display: flex;
        align-items: center;
        border-bottom: 1px solid #eee;
    }

    .legend-item:last-child {
        border-bottom: none;
    }

    .legend-item i {
        font-size: 16px;
    }

    .legend-item span {
        flex: 1;
    }

    /* Unique value symbology legend styles */
    .legend-header {
        font-weight: bold;
        padding: 8px 0 4px 0;
        border-bottom: none;
    }

    .legend-category {
        padding: 6px 0;
        font-size: 13px;
    }

    /* Custom scrollbar */
    .legend-items::-webkit-scrollbar {
        width: 8px;
    }

    .legend-items::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .legend-items::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .legend-items::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

<div id="side-panel">
    <div id="panel-toggle" onclick="togglePanel()">
        <span id="toggle-icon">‚óÑ</span>
    </div>

    <div class="panel-content">
        <!-- About Section -->
        <div class="about-section">
            <details open>
                <summary>‚ÑπÔ∏è About PEIT Map Creator</summary>
                <div class="about-content">
                    <p>
                        The <strong><a href="https://peit-map-creator.com/" target="_blank" rel="noopener noreferrer" style="color: #0066cc; text-decoration: none;">PEIT Map Creator</a></strong> replicates NTIA's <a href="https://nbam.ntia.gov/content/37fa42c6313e4bdb9d8a9c05d2624891/about" target="_blank" rel="noopener noreferrer" style="color: #0066cc; text-decoration: none;">APPEIT</a> tool functionality
                        without requiring an ArcGIS Pro license. This tool queries ESRI FeatureServer APIs to identify environmental and permitting constraints that may impact construction projects, including federal lands, critical habitats, historic sites, and EPA-regulated areas.
                    </p>
                    {% if xlsx_file %}
                    <p style="font-size: 11px; margin-top: 10px;">
                        üìä <strong>PEIT Report (XLSX):</strong> <a href="{{ xlsx_file }}" download target="_blank" rel="noopener noreferrer" style="color: #0066cc; text-decoration: none; font-weight: 500;">Download XLSX Report</a>
                        <br><span style="font-size: 10px; color: #666;">Summary table with linked resource areas</span>
                    </p>
                    {% endif %}

                    {% if pdf_file %}
                    <p style="font-size: 11px; margin-top: 10px;">
                        üìÑ <strong>PEIT Report (PDF):</strong> <a href="{{ pdf_file }}" download target="_blank" rel="noopener noreferrer" style="color: #0066cc; text-decoration: none; font-weight: 500;">Download PDF Report</a>
                        <br><span style="font-size: 10px; color: #666;">Formatted report with feature names and resource links</span>
                    </p>
                    {% endif %}
                    <p style="font-size: 10px; color: #666; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px; margin-bottom: 0; display: flex; align-items: center; justify-content: space-between;">
                        <a href="https://buymeacoffee.com/kucimaps" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center;">
                            <img src="https://cdn.buymeacoffee.com/buttons/v2/default-blue.png" alt="Buy Me A Coffee" style="height: 28px; width: auto; vertical-align: middle;">
                        </a>
                        <span>Created on {{ creation_date }}</span>
                    </p>
                </div>
            </details>
        </div>

        <!-- Legend Section -->
        <div class="legend-section">
            <h4>Active Layers</h4>
            <div class="legend-items">
                {{ legend_items|safe }}
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle panel collapse/expand
    function togglePanel() {
        var panel = document.getElementById('side-panel');
        var icon = document.getElementById('toggle-icon');

        panel.classList.toggle('collapsed');
        document.body.classList.toggle('panel-collapsed');
        icon.textContent = panel.classList.contains('collapsed') ? '‚ñ∫' : '‚óÑ';
    }

    // Update legend based on layer visibility from custom layer control
    function updateLegendVisibility() {
        // Check each legend item against layer control checkboxes
        var legendItems = document.querySelectorAll('.legend-item');
        legendItems.forEach(function(legendItem) {
            var layerName = legendItem.dataset.layerName;
            if (!layerName) return;

            // Find corresponding checkbox in layer control
            var layerCheckbox = document.querySelector('.layer-item[data-layer-name="' + layerName + '"] input[type="checkbox"]');

            if (layerCheckbox) {
                // Show/hide based on checkbox state
                legendItem.style.display = layerCheckbox.checked ? 'flex' : 'none';
            } else {
                // If no checkbox found, show by default
                legendItem.style.display = 'flex';
            }
        });
    }

    // Listen for custom layer visibility change events
    document.addEventListener('layerVisibilityChanged', function(e) {
        updateLegendVisibility();
    });

    // Initialize legend visibility on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Wait for layer control to initialize
        setTimeout(function() {
            updateLegendVisibility();
        }, 500);
    });
</script>
